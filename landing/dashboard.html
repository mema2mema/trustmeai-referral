
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TrustMe AI — Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme: { extend: { colors: { brand: "#6C5CE7" }}}}</script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-5xl mx-auto p-4">
    <header class="flex items-center justify-between py-4">
      <a href="/" class="text-xl font-bold">TrustMe <span class="text-brand">AI</span></a>
      <button id="logout" class="text-sm text-slate-300 hover:text-white">Logout</button>
    </header>

    <section class="mt-6 grid md:grid-cols-3 gap-4">
      <div class="p-4 rounded-xl border border-slate-800">
        <div class="text-slate-400 text-sm">Username</div>
        <div id="username" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 rounded-xl border border-slate-800">
        <div class="text-slate-400 text-sm">Role</div>
        <div id="role" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 rounded-xl border border-slate-800">
        <div class="text-slate-400 text-sm">Balance</div>
        <div id="balance" class="text-2xl font-extrabold">—</div>
      </div>
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold">Withdraw</h2>
      <div class="mt-3 grid md:grid-cols-4 gap-3">
        <input id="amount" type="number" step="0.01" min="0" placeholder="Amount" class="p-3 rounded-xl bg-slate-900 border border-slate-800">
        <input id="address" placeholder="Address (TRC20)" class="p-3 rounded-xl bg-slate-900 border border-slate-800 md:col-span-2">
        <select id="network" class="p-3 rounded-xl bg-slate-900 border border-slate-800">
          <option>TRC20</option>
          <option>ERC20</option>
          <option>BEP20</option>
        </select>
      </div>
      <button id="withdrawBtn" class="mt-3 px-5 py-3 rounded-xl bg-brand text-white">Submit Withdrawal</button>
      <div id="wmsg" class="mt-2 text-sm text-slate-300"></div>
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold">Recent Withdrawals</h2>
      <div id="table" class="mt-3 overflow-x-auto"></div>
    </section>
  </div>

  <script>
    const token = localStorage.getItem('jwt');
    if (!token) {
      location.href = '/';
    }

    async function api(path, options={}) {
      const res = await fetch(path, {
        ...options,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json', ...(options.headers || {}) }
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function load() {
      try {
        const me = await api('/me');
        document.getElementById('username').textContent = me.user.username ? '@' + me.user.username : me.user.first_name;
        document.getElementById('role').textContent = me.profile.role;
        document.getElementById('balance').textContent = me.profile.balance;

        const ws = await api('/withdrawals');
        const rows = ws.items.map(w => \`
          <tr class="border-b border-slate-800">
            <td class="px-3 py-2">\${w.id}</td>
            <td class="px-3 py-2">\${w.amount}</td>
            <td class="px-3 py-2">\${w.network}</td>
            <td class="px-3 py-2">\${w.status}</td>
            <td class="px-3 py-2 text-xs">\${w.requested_at}</td>
          </tr>\`).join('');
        document.getElementById('table').innerHTML = \`
          <table class="w-full text-sm">
            <thead><tr class="text-slate-400">
              <th class="px-3 py-2 text-left">ID</th>
              <th class="px-3 py-2 text-left">Amount</th>
              <th class="px-3 py-2 text-left">Network</th>
              <th class="px-3 py-2 text-left">Status</th>
              <th class="px-3 py-2 text-left">Requested</th>
            </tr></thead>
            <tbody>\${rows}</tbody>
          </table>\`;
      } catch (e) {
        console.error(e);
      }
    }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('jwt');
      location.href = '/';
    };

    document.getElementById('withdrawBtn').onclick = async () => {
      const amount = parseFloat(document.getElementById('amount').value);
      const address = document.getElementById('address').value;
      const network = document.getElementById('network').value;
      try {
        const r = await api('/withdraw', { method: 'POST', body: JSON.stringify({ amount, address, network }) });
        document.getElementById('wmsg').textContent = 'Submitted. ID ' + r.withdrawal.id + '. New balance ' + r.balance;
        load();
      } catch (e) {
        document.getElementById('wmsg').textContent = 'Error: ' + e.message;
      }
    };

    load();
  </script>
</body>
</html>
